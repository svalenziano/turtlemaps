(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();const y="https://www.stvn.us/pages/contact",P=15,W=15*1e3;class u{constructor(t,e=u.PATHS.osmfoundation){this.fetcher=t,this.api=e,t=t.bind(this)}static PATHS={osmfoundation:"https://nominatim.openstreetmap.org/search?","geocoding.ai":"https://nominatim.geocoding.ai/search?"};async resolveCoordinates(t,e=17){let o;if(u.isLatLon(t))o=u.parseLatLon(t);else{const s=await this.freeFormQuery(t);o=u.extractCentroid(s)}return{bbox:u.toBbox(o,e),centroid:o}}static toBbox({lat:t,lon:e},o){const s=2*Math.PI*6378137,i=256,a=s/(i*2**o),c=111320,k=Math.abs(Math.cos(t*Math.PI/180)*c),p=i/2*a/k,b=i/2*a/c,x=Number((e-p).toFixed(4)),S=Number((e+p).toFixed(4)),L=Number((t-b).toFixed(4)),v=Number((t+b).toFixed(4));return{minlat:L,minlon:x,maxlat:v,maxlon:S}}async freeFormQuery(t){const e=["q="+encodeURIComponent(t)];return e.push("format=geojson"),await(await this.fetcher(this.api+e.join("&"),{headers:{Referer:y}})).json()}static extractCentroid(t){if(!t.features)throw console.error("Features not found.  Here's the response:"),console.error(t),new Error("API response was unexpected");const e=t.features[0]?.geometry;if(typeof e=="object"&&e.type==="Point"&&Array.isArray(e.coordinates)){const[o,r]=e.coordinates;return{lat:r,lon:o}}else throw new Error("API response was unexpected")}static extractBbox(t){throw new Error("Not implemented")}static isLatLon(t){return/(-?\d+\.\d+),\s*(-?\d+\.\d+)/.test(t.trim())}static parseLatLon(t){const[e,o]=t.split(",").map(r=>r.trim()).map(r=>Number(r));if(e<-90||e>90)throw new Error("Latitude must be between -90 and 90");if(o<-180||o>180)throw new Error("Longitude must be between -180 and 180");return{lat:e,lon:o}}}class w{bottom=null;left=null;top=null;right=null;oBottom=null;oLeft=null;oTop=null;oRight=null;oWidth=null;oHeight=null;constructor(t){t&&this.parseOSMBbox(t)}overwriteOriginal(){[this.oBottom,this.oLeft,this.oTop,this.oRight]=[this.bottom,this.left,this.top,this.right],this.oWidth=this.width,this.oHeight=this.height}parseOSMBbox(t){this.bottom=t.minlat,this.left=t.minlon,this.top=t.maxlat,this.right=t.maxlon,this.overwriteOriginal()}parseLatitudeFirst(t){[this.bottom,this.left,this.top,this.right]=t,this.overwriteOriginal()}crop(t,e){if(this.isValid())if(this.oWidth*e/t<e){const r=this.oHeight*t/e,s=(this.oLeft+this.oRight)/2;this.left=s-r/2,this.right=s+r/2}else{const r=this.oWidth*e/t,s=(this.oBottom+this.oTop)/2;this.bottom=s-r/2,this.top=s+r/2}}isValid(){return typeof this.bottom=="number"&&typeof this.left=="number"&&typeof this.top=="number"&&typeof this.right=="number"&&typeof this.oBottom=="number"&&typeof this.oLeft=="number"&&typeof this.oTop=="number"&&typeof this.oRight=="number"&&typeof this.oWidth=="number"&&typeof this.oHeight=="number"}get svgViewBox(){return[this.left,this.bottom,this.width,this.height].join(" ")}get width(){if(this.left!==null&&this.right!==null)return Math.abs(this.right-this.left);throw new Error("Not initialized")}get height(){if(this.top!==null&&this.bottom!==null)return Math.abs(this.top-this.bottom);throw new Error("Not initialized")}get overpassBbox(){return[this.bottom,this.left,this.top,this.right].join(",")}}class g{constructor(t,e=g.PATHS["overpass.de"]){this.fetcher=t,this.api=e,this.timeout=W/1e3}timeout;static PATHS={"overpass.de":"https://overpass-api.de/api/interpreter"};async queryLayers(t,e){const o=this.formQueryFromLayers(t,e);return await this.queryGeneric(o)}async queryGeneric(t){const o=await(await fetch(this.api,{method:"POST",body:"data="+encodeURIComponent(t),headers:{"Content-Type":"text/plain; charset=UTF-8",Referer:y}})).json();return console.info(`Fetched ${o.elements.length} elements`),o}formQueryFromLayers(t,e){let o="";for(let s of t)o+=s.queryString;return`      [bbox:${e.overpassBbox}][out:json][timeout:${this.timeout}];
      (${o});
      out geom;`}static convertPoint(t){return[t.lon,t.lat]}static extractRelationGeom(t,e=null){const o=[];for(let r of t.members){const s=[];if(r.type==="way"){for(let i of r.geometry){let a;e?a=e([i.lon,i.lat]):a=[i.lon,i.lat],s.push(a)}o.push(s)}}return o}}class n{static default={bg:"rgba(86, 78, 105, 1)",light:"rgba(192, 192, 192, 1)",dark:"rgb(65, 54, 51)",bright:"rgba(160, 81, 71, 1)",green:"rgba(75, 90, 62, 1)",blue:"rgba(98, 125, 139, 1)",ick:"rgba(115, 28, 122, 1)",hilite:"rgba(255, 217, 0, 1)"}}class l{constructor(t,e,o){this.$container=t,this.width=e,this.height=o;let r=l.makeElement("svg");r.setAttribute("width",String(this.width)),r.setAttribute("height",String(this.height)),r.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`);let s=l.makeElement("rect");s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("width",String(this.width)),s.setAttribute("height",String(this.height)),s.setAttribute("fill",n.default.bg),r.append(s),this.$svg=r,this.$container.append(r)}$svg;static makeElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}static makePath(t){const e=l.makeElement("path");let o="";if(l.isListOfPoints(t))return o=l.PathCommand(t),e.setAttribute("d",o),l.pathIsOpen(t)&&e.setAttribute("fill","none"),e;for(let r of t)o+=l.PathCommand(r);return e.setAttribute("d",o),e.setAttribute("fill-rule","evenodd"),l.pathIsOpen(t[0])&&e.setAttribute("fill","none"),e}static isListOfPoints(t){return!Array.isArray(t[0][0])}static pathIsOpen(t,e=.05){const o=t[0],r=t[t.length-1];return d.dist(o[0],o[1],r[0],r[1])>e}static PathCommand(t,e=!1){if(t.length<2)throw new m("At least 2 points are required");let o=[`M ${t[0][0]},${t[0][1]}`];for(let r=1;r<t.length;r++)o.push(`L ${t[r][0]},${t[r][1]}`);return o.join(" ")}}class f{$g;name;colorFill;colorStroke;strokeWeight;tags;constructor(t){this.name=t.name,this.colorFill=t.colorFill,this.colorStroke=t.colorStroke,this.strokeWeight=t.strokeWeight,this.tags=t.tags,this.$g=l.makeElement("g"),this.updateStyles()}static makeDefaultLayers(){return f.defaultLayers.map(t=>new f(t))}updateStyles(){this.$g.setAttribute("fill",this.colorFill??"none"),this.$g.setAttribute("stroke",this.colorStroke??"none"),this.$g.setAttribute("stroke-width",this.strokeWeight?String(this.strokeWeight):"0")}matchesTags(t){for(let[e,o]of Object.entries(t))if(Object.keys(this.tags).includes(e)&&(this.tags[e]===null||this.tags[e].includes(o)))return!0;return!1}addGeometry(t){this.$g.append(t)}get queryString(){let t="";for(const e in this.tags){const o=this.tags[e];o===null?t+=`wr["${e}"];`:o.length>1?t+=`wr["${e}"~"${o.join("|")}"];`:t+=`wr["${e}"="${o[0]}"];`}return t}static strokesWeights={faint:.3,light:.5,medium:1.3,heavy:2.5,super:4};static defaultLayers=[{name:"Buildings - Residential",colorFill:n.default.bright,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.faint,tags:{building:["house","residential","detached","apartments","semidetached_house","bungalow","dormitory"]}},{name:"Buildings - All",colorFill:n.default.dark,colorStroke:n.default.bright,strokeWeight:this.strokesWeights.faint,tags:{building:null}},{name:"Paths",colorFill:n.default.bg,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.faint,tags:{highway:["footway","service","driveway","path","pedestrian"]}},{name:"Primary Roads",colorFill:null,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.super,tags:{highway:["motorway","motorway_link","trunk","trunk_link","primary","primary_link"]}},{name:"Secondary Roads",colorFill:null,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.heavy,tags:{highway:["secondary","secondary_link","tertiary","tertiary_link"]}},{name:"Tertiary Roads",colorFill:null,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.medium,tags:{highway:["residential","service"]}},{name:"Paths",colorFill:null,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.light,tags:{highway:["footway","service","driveway"]}},{name:"Water",colorFill:n.default.blue,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.faint,tags:{waterway:null,natural:["water"]}},{name:"Green Space",colorFill:n.default.green,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.faint,tags:{leisure:["park","garden"],landuse:["grass"]}},{name:"Public Space",colorFill:n.default.green,colorStroke:n.default.dark,strokeWeight:this.strokesWeights.faint,tags:{leisure:["village_green","track","dog_park"],amenity:["school"]}},{name:"Parking",colorFill:n.default.ick,colorStroke:n.default.bg,strokeWeight:this.strokesWeights.faint,tags:{parking:null,parking_space:null,amenity:["parking"],building:["parking","parking_garage","parking_shelter","car_park","parkingbuilding","parking_deck"]}},{name:"No Tresspassing",colorFill:n.default.bright,colorStroke:null,strokeWeight:this.strokesWeights.faint,tags:{access:["private"]}}]}class F{constructor(){fetch("./public/ui.html").then(t=>t.text()).then(console.log)}}class d{static slugify(t){return String(t).normalize("NFKD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase().replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")}static map(t,e,o,r,s,i=!1){const a=(t-e)/(o-e)*(s-r)+r;return i?r<s?this.constrain(a,r,s):this.constrain(a,s,r):a}static constrain(t,e,o){if(e>=o)throw new Error("Min should be less than max");return t<=e?e:t>=o?o:t}static dist(t,e,o,r){return Math.hypot(t-o,e-r)}static saveSVG(t){if(!t){const i=document.querySelector("svg");if(!i)throw new Error("SVG was not provided");t=i}let e=new XMLSerializer().serializeToString(t),o=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(o);s(r);function s(i,a="image.svg"){let c=document.createElement("a");c.setAttribute("download",a),c.setAttribute("href",i),c.setAttribute("target","_blank"),c.click()}}}class m extends Error{date;constructor(t){super(t),Object.setPrototypeOf(this,m.prototype),this.name="DataError",this.date=new Date}}class A{constructor(t){this.container=t,this.bbox=new w,this.query=null,this.centroid=null,this.svg=new l(document.body,window.innerWidth,window.innerWidth),this.osm=new g(fetch),this.nom=new u(fetch),this.layers=f.makeDefaultLayers(),this.layers.forEach(e=>this.svg.$svg.append(e.$g))}bbox;query;centroid;svg;layers;nom;osm;async jump(t,e=P){let o=null,r=null,s=null;try{o=await this.nom.resolveCoordinates(t,e),this.bbox=new w(o.bbox),r=this.osm.formQueryFromLayers(this.layers,this.bbox),s=await this.osm.queryGeneric(r),this.drawOSM(s)}catch(i){throw i instanceof Error&&(console.error("`jump` failed.  Dumping data and re-throwing error"),o&&console.error(o),r&&console.error(r),s&&console.error(s)),i}}async fetchLocalOSM(t){try{const o=await(await fetch(t)).json();if(o.bbox)this.bbox.parseLatitudeFirst(o.bbox);else throw new m("no bbox was found");return this.centroid=o.centroid,o}catch(e){throw e instanceof m?e:new Error(`Fetch for "${t}" failed.`)}}drawOSM(t){const e=this.mapPointToSVG.bind(this),o=t.elements;for(let r of o){if(r.type==="node")continue;const s=this.getLayer(r);if(!(s instanceof f)){console.warn("Layer not found for",r);continue}if(r.type==="way"){const i=r.geometry.map(a=>g.convertPoint(a)).map(this.mapPointToSVG,this);s.addGeometry(l.makePath(i))}else if(r.type==="relation"){const i=g.extractRelationGeom(r,e),a=l.makePath(i);a.setAttribute("stroke",n.default.hilite),s.addGeometry(a)}}}getLayer(t){const e=t.tags;for(let o of this.layers)if(o.matchesTags(e))return o;return t}mapOSMPointToSVG(t,e=3){if(!this.bbox.isValid())throw new Error("Only works with valid bbox");return{lat:Number(d.map(t.lat,this.bbox.top,this.bbox.bottom,0,this.svg.height).toFixed(e)),lon:Number(d.map(t.lon,this.bbox.left,this.bbox.right,0,this.svg.width).toFixed(e))}}mapPointToSVG(t){if(!this.bbox.isValid())throw new Error("Only works with valid bbox");return[d.map(t[0],this.bbox.left,this.bbox.right,0,this.svg.width),d.map(t[1],this.bbox.top,this.bbox.bottom,0,this.svg.height)]}}window.U=d;document.addEventListener("DOMContentLoaded",async()=>{const h=document.querySelector("section.app");if(!h)throw new Error("Container not found");const t=new A(h),e=await t.fetchLocalOSM("./data/durham_nc.json");console.log(e),console.log(t.bbox),t.drawOSM(e),new F});
